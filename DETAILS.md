# クイズアプリ - 画面一覧と処理詳細

## 概要
クイズアプリは、Google Apps Script (GAS) とGitHub Pagesでホスティングされるフロントエンドで構成されています。
ユーザーは6つのジャンルから選び、初級・中級・上級・超級の4段階の難易度で問題に挑戦できます。
全問正解で合格証が発行され、エクストラステージでランキングに挑戦できます。

---

## 画面一覧

### 1. ニックネーム入力画面 (`nicknameScreen`)
**目的**: 合格証に表示するニックネームを入力

#### ボタンと処理
| ボタン名 | 発生処理 | キャッシュ | スプシREAD | スプシINSERT |
|---------|---------|-----------|-----------|-------------|
| 次へ | `submitNickname()` - ニックネームをlocalStorageに保存し、ジャンル選択画面へ遷移 | localStorage書込 | なし | なし |

**想定頻度**: 初回アクセス時のみ（1回）/ ニックネーム変更時（低頻度）

---

### 2. ジャンル選択画面 (`genreScreen`)
**目的**: 挑戦するジャンルと難易度を選択

#### ボタンと処理
| ボタン名 | 発生処理 | キャッシュ | スプシREAD | スプシINSERT |
|---------|---------|-----------|-----------|-------------|
| 各難易度ボタン（初級/中級/上級） | `selectGenreAndLevel(genre, levelIndex)` → `loadLevel()` - 問題をGASから取得 | CacheService読込 (7日間) | getQuestions() でスプシ読込（キャッシュ未存在時） | なし |
| 超級ボタン | `startUltraMode(genre)` - 超級モード開始、全レベルの問題を取得 | CacheService読込 (7日間) | getUltraModeQuestions() で全レベル読込（キャッシュ未存在時） | なし |
| エクストラステージボタン | `startUltraMode()` - エクストラモード開始、全ジャンル・全レベルの問題を取得 | CacheService読込 (7日間) | getAllQuestionsForExtraMode() で全問題読込（キャッシュ未存在時） | なし |
| ランキングを見る | `showRanking()` - ランキング画面へ遷移 | なし | getTopScores() でランキングシート読込 ⚠️要改善（※1） | なし |
| ローカルデータをリセット | `resetLocalStorage()` - localStorageを全削除してトップへ | localStorage削除 | なし | なし |
| 合格証バッジ（メダル） | `openCertificateModal(storageKey)` - 過去の合格証をモーダル表示 | localStorage読込 | なし | なし |
| ニックネーム編集ボタン | `editNickname()` - ニックネーム入力画面へ遷移 | なし | なし | なし |

**想定頻度**: セッション毎に複数回（高頻度）

**キャッシュ詳細**:
- **CacheService**: GAS側で問題データをキャッシュ（キー: `q_ジャンル名_レベル`, `a_ジャンル名_レベル`, `h_ジャンル名_レベル`）
- **キャッシュ期間**: 7日間（604800秒）
- **自動リロード**: キャッシュ未存在時は `reloadSingleCache()` で自動的にスプレッドシートから読込

#### 改善案（※1）: ランキング取得のキャッシュ化

**現状の課題**:
- `getTopScores()` が呼ばれるたびにスプレッドシートから全データを読み込んでいる
- ランキング表示のたびにスプシREADが発生し、負荷が高い

**改善提案**:
1. **INSERT/UPDATE時にキャッシュも更新**
   - `saveScore()` でスコア登録した際に、ランキングデータもCacheServiceに保存
   - キャッシュキー例: `ranking_エクストラステージ`

2. **READ時はキャッシュ優先**
   - `getTopScores()` でまずキャッシュを確認
   - キャッシュがあればそれを返す（スプシREADなし）
   - キャッシュがなければスプシから読み込んでキャッシュに保存

3. **キャッシュ期間の設定**
   - 短めに設定（例: 600秒 = 10分）
   - リアルタイム性と負荷のバランスを取る

**期待効果**:
- スプレッドシート読み込み頻度が大幅に削減
- ランキング表示が高速化
- GASの実行時間制限に余裕ができる

**実装イメージ**:
```javascript
// saveScore() の最後に追加
function saveScore(payload) {
  // ... 既存のスコア保存処理 ...

  // ランキングキャッシュを無効化（次回READ時に再構築）
  cache.remove('ranking_' + genre);

  return { success: true, ... };
}

// getTopScores() を修正
function getTopScores(payload) {
  var cache = CacheService.getScriptCache();
  var cacheKey = 'ranking_' + genre;

  // キャッシュから取得を試みる
  var cached = cache.get(cacheKey);
  if (cached) {
    return JSON.parse(cached);
  }

  // キャッシュがなければスプシから読み込み
  var sheet = ss.getSheetByName('スコアランキング');
  var data = sheet.getDataRange().getValues();
  // ... ソート・フィルタリング処理 ...

  var result = { hallOfFame: hallOfFame, rankings: rankings };

  // キャッシュに保存（10分間）
  cache.put(cacheKey, JSON.stringify(result), 600);

  return result;
}
```

---

### 3. 問題画面 (`questionScreen`)
**目的**: 問題を表示し、ユーザーが回答

#### ボタンと処理
| ボタン名 | 発生処理 | キャッシュ | スプシREAD | スプシINSERT |
|---------|---------|-----------|-----------|-------------|
| 選択肢ボタン（単一選択） | `selectSingleChoice(button)` - 回答を選択し、userAnswers配列に保存 | localStorage書込（間接的） | なし | なし |
| 選択肢ボタン（複数選択） | `toggleChoiceByButton(button)` - 複数選択の切り替え | localStorage書込（間接的） | なし | なし |
| 前へボタン（‹） | `previousQuestion()` - 前の問題へ戻る | なし | なし | なし |
| 次へボタン（›） | `nextQuestion()` - 次の問題へ進む | なし | なし | なし |
| 採点ボタン | `submitAllAnswers()` - 全回答をGASへ送信して採点 | CacheService読込 (正解データ・ヒント情報) | judgeAllAnswers() で正解・ヒント情報読込（キャッシュ未存在時） | なし |
| 問題番号ドット | `jumpToQuestion(index)` - 指定問題へジャンプ | なし | なし | なし |

**想定頻度**: 1セッション中に10回程度（問題数分）

**キャッシュ詳細**:
- **CacheService**: 正解データ（`a_ジャンル名_レベル`）とヒント情報（`h_ジャンル名_レベル`）をキャッシュから読込
- **キャッシュ期間**: 7日間

---

### 4. 不合格画面 (`failScreen`)
**目的**: 不合格時に結果とヒントを表示

#### ボタンと処理
| ボタン名 | 発生処理 | キャッシュ | スプシREAD | スプシINSERT |
|---------|---------|-----------|-----------|-------------|
| 𝕏 で共有する | `shareFailToX()` - Xで結果をシェア | なし | なし | なし |
| もう一度挑戦する | `retryLevel()` - 同じレベルを再挑戦 | CacheService読込 | getQuestions() でスプシ読込（キャッシュ未存在時） | なし |

**想定頻度**: 不合格時（中頻度）

---

### 5. 合格証明書画面 (`certificateScreen`)
**目的**: 合格証を生成・表示

#### ボタンと処理
| ボタン名 | 発生処理 | キャッシュ | スプシREAD | スプシINSERT |
|---------|---------|-----------|-----------|-------------|
| 合格証をダウンロード | `downloadCertificate()` - 合格証画像をダウンロード | なし | なし | なし |
| 𝕏 で共有する | `shareToX()` - Xで合格をシェア | なし | なし | なし |
| スコアを登録する | `registerExtraScore(evt)` - エクストラステージのスコアを送信 | なし | なし | saveScore() でスコアランキングシートへINSERT/UPDATE |
| 次のレベルへすすむ | `nextSection()` - 次の難易度へ進む | CacheService読込 | getQuestions() でスプシ読込（キャッシュ未存在時） | なし |
| ジャンル選択へ戻る | `backToGenreSelection()` - ジャンル選択画面へ戻る | なし | なし | なし |

**想定頻度**: 合格時（中頻度）

**スプレッドシート詳細**:
- **INSERT/UPDATE**: `saveScore()` - 同じbrowserIdが存在すれば更新、なければ新規追加
- **対象シート**: `スコアランキング`
- **保存データ**: browserId, nickname, score, timestamp, genre, isPerfect

---

### 6. 超級モード問題画面 (`ultraQuestionScreen`)
**目的**: 超級モードの問題を表示（10秒制限付き）

#### ボタンと処理
| ボタン名 | 発生処理 | キャッシュ | スプシREAD | スプシINSERT |
|---------|---------|-----------|-----------|-------------|
| 選択肢ボタン（単一選択） | `submitUltraAnswer([value])` - 即座に回答判定（ハッシュ値比較） | なし | なし | なし |
| 選択肢ボタン（複数選択） | `toggleUltraChoice(button)` - 選択切り替え | なし | なし | なし |
| 回答するボタン（複数選択） | `submitUltraMultipleAnswer()` - 複数選択回答を送信 | なし | なし | なし |
| 回答するボタン（入力式） | `submitUltraInputAnswer()` - 入力式回答を送信 | なし | なし | なし |

**想定頻度**: 超級モード挑戦時（低頻度）

**キャッシュ詳細**:
- **CacheService**: 全レベルの問題データをキャッシュから読込（`q_ジャンル名_レベル`, `a_ジャンル名_レベル`）
- **ハッシュ判定**: 正解データはSHA-256ハッシュ値で比較（セキュリティ対策）

---

### 7. 超級モード失敗画面 (`ultraFailScreen`)
**目的**: 超級モード失敗時の結果表示

#### ボタンと処理
| ボタン名 | 発生処理 | キャッシュ | スプシREAD | スプシINSERT |
|---------|---------|-----------|-----------|-------------|
| スコアを登録する | `registerExtraScoreFailed(evt)` - エクストラステージの途中スコアを送信 | なし | なし | saveScore() でスコアランキングシートへINSERT/UPDATE |
| ジャンル選択へ戻る | `backToGenreSelection()` - ジャンル選択画面へ戻る | なし | なし | なし |
| もう一度挑戦 | `retryUltraMode()` - 超級モードを再挑戦 | CacheService読込 | getUltraModeQuestions() で全レベル読込 | なし |

**想定頻度**: 超級モード失敗時（低頻度）

---

### 8. ランキング画面 (`rankingScreen`)
**目的**: エクストラステージのTOP10ランキング表示

#### ボタンと処理
| ボタン名 | 発生処理 | キャッシュ | スプシREAD | スプシINSERT |
|---------|---------|-----------|-----------|-------------|
| ジャンル選択へ戻る | `backToGenreSelection()` - ジャンル選択画面へ戻る | なし | なし | なし |

**想定頻度**: エクストラステージ挑戦者のみ（低頻度）

**スプレッドシート詳細**:
- **READ**: `getTopScores()` - スコアランキングシートから全問正解者と挑戦者TOP10を取得
- **対象シート**: `スコアランキング`

---

## キャッシュ処理詳細

### CacheService（GAS側）
| キャッシュキー | 保存内容 | 有効期間 | 生成タイミング |
|--------------|---------|---------|---------------|
| `q_ジャンル名_レベル` | 問題データ（正解なし） | 7日間（604800秒） | キャッシュ未存在時に自動生成 or 手動リロード時 |
| `a_ジャンル名_レベル` | 正解データ | 7日間（604800秒） | キャッシュ未存在時に自動生成 or 手動リロード時 |
| `h_ジャンル名_レベル` | ヒント情報 | 7日間（604800秒） | キャッシュ未存在時に自動生成 or 手動リロード時 |
| `rate_ユーザーID` | レート制限カウンター | 60秒 | リクエスト毎（10回/分まで） |
| `cache_reload_lock` | キャッシュリロードロック | 60秒 | 手動リロード実行時（多重実行防止） |

**注意**:
- 通常の問題取得時のキャッシュ未存在: `reloadSingleCache()` で該当ジャンル・レベルのみリロード
- 超級/エクストラのキャッシュ未存在: `reloadQuestionCache()` で全ジャンル・全レベルを一括リロード

### localStorage（クライアント側）
| キー | 保存内容 | 削除タイミング |
|-----|---------|--------------|
| `quiz_nickname` | ニックネーム | リセット時 |
| `quiz_browser_id` | ブラウザ識別ID（UUID） | リセット時 |
| `ジャンル番号-級番号` (例: `1-1`) | 合格証メタデータ（Base64エンコード） | リセット時 |
| `ALL` | エクストラステージ合格証メタデータ | リセット時 |

---

## スプレッドシート処理詳細

### READ処理

#### 1. 問題取得 (`getQuestions`)
- **対象シート**: ジャンル名シート（例: `ジャンル1`, `ジャンル2`）
- **読込タイミング**: レベル開始時（キャッシュ未存在時）
- **読込範囲**: 全データ範囲（`getDataRange().getValues()`）
- **フィルタ条件**: レベル列で指定レベルに一致する行のみ抽出
- **読込列**: 問題ID, レベル, 選択形式, 表示形式, 問題文, 選択肢A～D, 正解, ヒントURL, ヒントテキスト
- **頻度**: 低頻度（キャッシュヒット率が高い）

#### 2. 超級モード問題取得 (`getUltraModeQuestions`)
- **対象シート**: 全ジャンルシート（キャッシュ未存在時は全ジャンル・全レベルを一括リロード）
- **読込タイミング**: 超級モード開始時（キャッシュ未存在時のみ）
- **読込範囲**: 全ジャンル・全レベルの全データ範囲（`reloadQuestionCache()` を呼び出し）
- **頻度**: 極低頻度（超級モード挑戦時 × キャッシュミス時のみ）

#### 3. エクストラモード問題取得 (`getAllQuestionsForExtraMode`)
- **対象シート**: 全ジャンルシート（キャッシュ未存在時は全ジャンル・全レベルを一括リロード）
- **読込タイミング**: エクストラモード開始時（キャッシュ未存在時のみ）
- **読込範囲**: 全ジャンル・全レベルの全データ範囲（`reloadQuestionCache()` を呼び出し）
- **頻度**: 極低頻度（エクストラモード挑戦時 × キャッシュミス時のみ）

#### 4. ヒント情報取得 (`loadHintsFromSheet`)
- **対象シート**: ジャンル名シート
- **読込タイミング**: 採点時（キャッシュ未存在時）
- **読込範囲**: 全データ範囲
- **頻度**: 低頻度（キャッシュヒット率が高い）

#### 5. ランキング取得 (`getTopScores`)
- **対象シート**: `スコアランキング`
- **読込タイミング**: ランキング画面表示時
- **読込範囲**: 全データ範囲
- **フィルタ条件**: ジャンル列で指定ジャンルに一致する行のみ抽出
- **ソート**: 全問正解者は古い順、挑戦者はスコア降順
- **頻度**: 低頻度（ランキング画面表示時のみ）

---

### INSERT/UPDATE処理

#### 1. スコア登録 (`saveScore`)
- **対象シート**: `スコアランキング`
- **実行タイミング**: エクストラステージ合格/失敗時にスコア登録ボタンをクリック
- **処理内容**:
  - 同じbrowserIdが存在する場合: スコアが高い場合のみUPDATE
  - 同じbrowserIdが存在しない場合: 新規レコードをINSERT（`appendRow()`）
- **INSERT列**: browserId, nickname, score, timestamp, genre, isPerfect
- **頻度**: 低頻度（エクストラステージ挑戦者のみ）

#### 2. キャッシュリロード（管理用）
- **関数**: `reloadQuestionCache()`
- **対象シート**: 全ジャンルシート
- **実行タイミング**: スプレッドシートのボタンから手動実行（問題更新時）
- **処理内容**: 全ジャンル・全レベルのキャッシュをクリアして再構築
- **ロック機構**: `cache_reload_lock` で多重実行を防止
- **頻度**: 極低頻度（問題更新時のみ）

---

## 処理頻度まとめ

| 処理 | 頻度 | キャッシュ | スプシREAD | スプシINSERT |
|-----|------|-----------|-----------|-------------|
| ニックネーム入力 | 初回のみ | localStorage書込 | なし | なし |
| ジャンル選択 | 高頻度 | localStorage読込 | なし | なし |
| 問題取得 | 中頻度 | CacheService読込 | キャッシュ未存在時のみ | なし |
| 問題回答 | 高頻度 | なし | なし | なし |
| 採点 | 中頻度 | CacheService読込 | キャッシュ未存在時のみ | なし |
| 合格証生成 | 中頻度 | localStorage書込 | なし | なし |
| スコア登録 | 低頻度 | なし | なし | INSERT/UPDATE |
| ランキング表示 | 低頻度 | なし | READ | なし |
| キャッシュリロード | 極低頻度 | CacheService書込 | 全シートREAD | なし |

---

## レート制限

### 実装詳細
- **関数**: `checkRateLimit(userId)`
- **制限**: 60秒間に10回まで
- **対象処理**: `getQuestions`, `judgeAllAnswers`, `getUltraModeQuestions`, `getAllQuestionsForExtraMode`
- **キャッシュキー**: `rate_ユーザーID`
- **超過時**: エラーメッセージ「しばらく待ってから再度お試しください」を返す

---

## 技術スタック

### フロントエンド
- **HTML/CSS/JavaScript**: メイン画面構築
- **DOMPurify**: XSS対策（サニタイズ）
- **html2canvas**: 合格証画像生成
- **localStorage**: ニックネーム・合格証メタデータ保存

### バックエンド（GAS）
- **Google Apps Script**: サーバーサイド処理
- **CacheService**: 問題データ・正解データキャッシュ
- **SpreadsheetApp**: スプレッドシート読込・書込
- **Utilities**: SHA-256ハッシュ生成（超級モード）

### ホスティング
- **GitHub Pages**: 静的ファイル配信
- **Google Apps Script Web App**: APIエンドポイント

---

## セキュリティ対策

1. **XSS対策**: DOMPurifyでHTML出力をサニタイズ
2. **正解データ保護**: 超級モードではSHA-256ハッシュ値で判定（正解がクライアントに送信されない）
3. **レート制限**: 60秒間に10回までのリクエスト制限
4. **CORS対応**: GAS側で `XFrameOptionsMode.ALLOWALL` を設定
5. **キャッシュロック**: 多重リロードを防止するロック機構

---

## 備考
- **ジャンル数**: 6つ（`config.js`のGENRE_NAMESで設定可能）
- **難易度**: 4段階（初級・中級・上級・超級）
- **問題数**: 各レベル10問ずつ
- **超級モード**: 全レベルの問題をシャッフルして出題
- **エクストラモード**: 全ジャンル・全レベルの問題をシャッフルして出題
